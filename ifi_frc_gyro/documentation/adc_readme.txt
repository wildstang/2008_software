****************************************************************

You are free to use this source code for any non-commercial
use. Please do not make copies of this source code, modified
or un-modified, publicly available on the internet or
elsewhere without permission. Thanks.

Copyright ©2005-2008 R. Kevin Watson. All rights are reserved.

****************************************************************
The source code in adc.c/.h contains software to setup and run
your robot controllers analog-to-digital converter in the 
background. A few advantages of using this software include 
parallel, non-blocking operation of the ADC hardware, precise 
control over the sampling period, which is important for signal 
processing and control applications and the ability to make more 
precise measurements using oversampling. Number of channels, 
sample rate and oversampling parameters can be changed by 
editing adc.h and re-compiling.

This software makes the assumption that when it's running, it 
solely controls the analog to digital conversion and timer 4 
hardware.

WARNING: The higher sampling rates can place quite a load on
the robot controllers CPU. If you get the red-light-of-death
or notice any general wackiness in the operation of your
robot, first try a lower sampling rate to determine if this
is the problem. In general, you should select the lowest
sampling rate that meets your performance criteria.

This source code will work with the PIC18F8722-based FIRST 
Robotics robot controller only.

The included project files were built with MPLAB version 8.00.
If your version of MPLAB complains about the project version, 
the best thing to do is just create a new project with MPLAB's 
project wizard.

Support for this software can be received by posting a help
request in the programming section of the Chief Delphi forums
(http://www.chiefdelphi.com).

****************************************************************

Usage notes:

1) A #include statement for the adc.h header file must be 
included at the beginning of each source file that calls the 
functions in adc.c. The statement should look like this: 
#include "adc.h".

2) Define the number of analog channels that you'd like this
software to track by opening adc.h and following the embedded
instructions above #define NUM_ADC_CHANNELS.

3) For advanced users, analog channels can be oversampled to
decrease noise and gain resolution in your analog measurements.
The oversampling ratio can be changed from the default x4
by commenting-out the line #define ADC_SAMPLES_PER_UPDATE_4
found in adc.h and then removing the // from in front of one
of the other options. Measurement range and resolution can be 
determined from this table:

ADC Samples  Effective
 Averaged     Bits of    Measurement   Voltage
Per Update   Resolution     Range      Per Bit
___________  __________  ___________  _________
      1          10        0-1023      4.88 mV
      2          10        0-1023      4.88 mV
      4          11        0-2047      2.44 mV
      8          11        0-2047      2.44 mV
     16          12        0-4095      1.22 mV
     32          12        0-4095      1.22 mV
     64          13        0-8191       610 uV
    128          13        0-8191       610 uV
    256          14        0-16383      305 uV


4) Finally, pick the master sample rate by selecting one
of the available rates found in adc.h. The update rate can
be determined using this formula:

Update Rate = 
    Sample Rate / (Samples Per Update * Number Of Channels)


****************************************************************


Here's a description of the functions in adc.c:

Get_ADC_Result_Count()

This function returns an unsigned char containing the number 
of ADC updates generated since Reset_ADC_Result_Count() or 
Initialize_ADC() were called. Use this function to determine
when fresh analog to digital conversion data is ready.


Reset_ADC_Result_Count()

This function can be called to reset the ADC update counter
to zero.


Get_ADC_Result()

This function can be called to retreive analog to digital
conversion results. Call this function with an unsigned char
containing the ADC channel you'd like data from. This function
will return an unsigned int with the last conversion result.

Convert_ADC_to_mV()

This function converts the raw value generated by the ADC to
millivolts.


Initialize_ADC()

This function initializes the ADC hardware and software.
Once called, analog to digital conversions will automatically
take place in the background. This should be called from the
teleop.c/Initialization() function.


Disable_ADC()

This function disables the ADC hardware and software. To
minimize the load on the microcontroller, this function should 
be called when the ADC functionality is no longer needed.

 
Timer_4_ISR()

This function is automatically called when timer 4 causes an
interrupt and shouldn't be called directly. New analog to
digital conversion data is processed and then a new conversion
is started within this function. You should not call this
function yourself.



Kevin Watson
kevinw@jpl.nasa.gov
